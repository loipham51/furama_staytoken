{% extends "base.html" %}
{% block title %}Furama StayToken{% endblock %}
{% block content %}
{% csrf_token %}
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
  // Ensure libraries are loaded
  window.addEventListener('load', function() {
    if (typeof jsQR === 'undefined') {
      console.error('jsQR library failed to load');
    } else {
      console.log('jsQR library loaded successfully');
    }
    
    if (typeof qrcode === 'undefined') {
      console.error('qrcode library failed to load');
    } else {
      console.log('qrcode library loaded successfully');
    }
  });
  
  // Also check after a delay
  setTimeout(function() {
    if (typeof jsQR === 'undefined') {
      console.error('jsQR library still not loaded after delay');
    }
    if (typeof qrcode === 'undefined') {
      console.error('qrcode library still not loaded after delay');
    }
  }, 3000);
</script>
{{ available_vouchers|json_script:"available-vouchers" }}
<div x-data="homeView()" x-init="init()" class="mx-auto flex max-w-md flex-col gap-5 px-4 pb-16 pt-6">
  <!-- QR Code Scanner Section -->
  <section class="rounded-3xl border border-[#dfeee2] bg-white p-6 shadow-sm">
    <div class="flex items-start gap-3">
      <div class="grid h-12 w-12 place-items-center rounded-full bg-[#d9f2dd] text-[#166534]">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-6 w-6" fill="currentColor" aria-hidden="true">
          <path d="M3 11h8V3H3v8zm2-6h4v4H5V5zm8-2v8h8V3h-8zm6 6h-4V5h4v4zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm8 4h2v2h-2zm4-8h2v2h-2zm0 4h2v2h-2zm-4 0h2v2h-2zm-4-4h2v2h-2zm8 8h2v2h-2zm-4 0h2v2h-2z"/>
        </svg>
      </div>
      <div class="min-w-0">
        <p class="text-xs font-semibold uppercase tracking-wide text-[#166534]/80">Furama Resort guests</p>
        <h1 class="mt-1 text-lg font-semibold text-[#14532d]">Claim your digital vouchers</h1>
        <p class="mt-2 text-sm text-[#14532d]/80">Scan QR code or enter voucher code to claim your rewards. Mint on-chain via ERC-1155 and store in your custodial wallet.</p>
      </div>
    </div>
    
    <!-- QR Scanner Button -->
    <div class="mt-4 space-y-3">
      <button 
        type="button" 
        @click="startQRScanner()"
        x-show="!qrScannerActive"
        class="w-full rounded-2xl border-2 border-dashed border-[#15803d] bg-[#f8fdf9] p-6 text-center transition-colors hover:bg-[#f1faf3]"
      >
        <div class="flex flex-col items-center gap-3">
          <div class="grid h-16 w-16 place-items-center rounded-full bg-[#d9f2dd] text-[#166534]">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-8 w-8" fill="currentColor" aria-hidden="true">
              <path d="M3 11h8V3H3v8zm2-6h4v4H5V5zm8-2v8h8V3h-8zm6 6h-4V5h4v4zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm8 4h2v2h-2zm4-8h2v2h-2zm0 4h2v2h-2zm-4 0h2v2h-2zm-4-4h2v2h-2zm8 8h2v2h-2zm-4 0h2v2h-2z"/>
            </svg>
          </div>
          <div>
            <p class="text-sm font-semibold text-[#14532d]">Scan QR Code</p>
            <p class="text-xs text-[#166534]/80">Point your camera at a voucher QR code</p>
          </div>
        </div>
      </button>

      <!-- QR Scanner Camera View -->
      <div x-show="qrScannerActive" class="w-full rounded-2xl border border-[#15803d] bg-black p-4">
        <div class="relative mx-auto h-64 w-full overflow-hidden rounded-xl">
          <video 
            x-ref="video" 
            class="h-full w-full object-cover"
            autoplay
            playsinline
          ></video>
          
          <!-- Scanner overlay -->
          <div class="absolute inset-0 flex items-center justify-center">
            <div class="h-48 w-48 rounded-lg border-2 border-white shadow-lg"></div>
          </div>
          
          <!-- Status message -->
          <div class="absolute bottom-2 left-2 right-2 rounded-lg bg-black/70 px-3 py-2 text-center text-white text-sm">
            <span x-text="statusMessage"></span>
          </div>
        </div>
        
        <div class="mt-3 flex gap-2">
          <button 
            @click="stopCamera()"
            class="flex-1 rounded-xl bg-red-600 px-4 py-2 text-sm font-semibold text-white"
          >
            Stop Camera
          </button>
        </div>
      </div>
      
      <!-- Manual Code Input -->
      <div class="rounded-2xl border border-[#e7f3ea] bg-[#f8fdf9] p-4">
        <div class="flex items-center gap-2 mb-3">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-4 w-4 text-[#166534]" fill="currentColor" aria-hidden="true">
            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
          </svg>
          <p class="text-sm font-semibold text-[#14532d]">Or enter voucher code manually</p>
        </div>
        <div class="flex gap-2">
          <input 
            type="text" 
            x-model="manualCode"
            @keyup.enter="claimByCode()"
            placeholder="Enter voucher code..."
            class="flex-1 rounded-xl border border-[#e7f3ea] px-3 py-2 text-sm placeholder:text-[#166534]/50 focus:border-[#15803d] focus:outline-none"
          />
          <button 
            type="button" 
            @click="claimByCode()"
            :disabled="!manualCode.trim()"
            class="rounded-xl bg-[#15803d] px-4 py-2 text-sm font-semibold text-white disabled:bg-slate-300 disabled:cursor-not-allowed"
          >
            Claim
          </button>
        </div>
        
        <!-- Test QR Code -->
        <div class="mt-4 text-center">
          <p class="text-xs text-[#166534]/60 mb-2">Test QR Code:</p>
          <div class="inline-block p-2 bg-white border border-gray-300 rounded">
            <div id="test-qr-code" class="w-32 h-32"></div>
          </div>
          <p class="text-xs text-[#166534]/60 mt-2">Scan this test QR code to verify scanner works</p>
          <button 
            @click="testQRScanner()"
            class="mt-2 rounded-lg bg-blue-500 px-3 py-1 text-xs text-white hover:bg-blue-600"
          >
            Test QR Scanner (Simulate)
          </button>
        </div>
      </div>
    </div>
    
    <template x-if="demoMode">
      <p class="mt-4 rounded-2xl bg-[#f1faf3] px-3 py-2 text-xs text-[#14532d]/80">Demo mode: Use any voucher code to simulate claim.</p>
    </template>
  </section>

  <!-- Wallet summary -->
  <section class="rounded-3xl border border-[#dfeee2] bg-white p-6 shadow-sm">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-xs uppercase tracking-wide text-[#166534]/70">StayToken wallet</p>
        <p class="mt-1 font-mono text-sm text-[#14532d]" x-text="walletAddress ? shortAddress(walletAddress) : 'Not created yet'"></p>
      </div>
      <template x-if="walletAddress">
        <button type="button" class="text-xs text-[#15803d] underline" @click="copy(walletAddress)">Copy</button>
      </template>
    </div>
    <div class="mt-4 grid grid-cols-2 gap-3 rounded-2xl bg-[#f1faf3] p-4 text-center">
      <div>
        <p class="text-xs uppercase tracking-wide text-[#15803d]/70">Voucher count</p>
        <p class="mt-1 text-2xl font-semibold text-[#14532d]" x-text="voucherCount"></p>
      </div>
      <div>
        <p class="text-xs uppercase tracking-wide text-[#15803d]/70">Total value</p>
        <div class="mt-1 flex items-center justify-center gap-2">
          <p class="text-xl font-semibold text-[#b09114]" x-text="valueHidden ? '*****' : voucherValue"></p>
          <button type="button" class="text-xs text-[#166534]/70 underline" @click="toggleValue()" x-text="valueHidden ? 'Show' : 'Hide'"></button>
        </div>
      </div>
    </div>
    <p class="mt-3 text-xs text-slate-500" x-text="walletStatus"></p>
    <template x-if="loggedIn">
      <a href="/me" class="mt-3 inline-flex items-center gap-2 text-xs font-semibold text-[#166534] underline">View account & vouchers</a>
    </template>
  </section>

  <!-- Voucher list (Recent vouchers) -->
  <section class="rounded-3xl border border-[#dfeee2] bg-white p-6 shadow-sm">
    <div class="flex items-center gap-2 text-[#166534]">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-4 w-4" fill="currentColor" aria-hidden="true">
        <path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.38 0-2.53.93-2.87 2.2L12 5.24l-.13-.04C11.53 3.93 10.38 3 9 3 7.34 3 6 4.34 6 6c0 .35.07.69.18 1H4c-1.1 0-2 .9-2 2v2c0 .55.45 1 1 1h1v9c0 .55.45 1 1 1h14c.55 0 1-.45 1-1v-9h1c.55 0 1-.45 1-1V8c0-1.1-.9-2-2-2zM9 5c.55 0 1 .45 1 1s-.45 1-1 1S8 6.55 8 6s.45-1 1-1zm-3 6h5v9H6v-9zm11 9h-5v-9h5v9zm2-11H4V8h16v1zm-5-2c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z" />
      </svg>
      <h2 class="text-sm font-semibold">Recent vouchers</h2>
    </div>
    <template x-if="voucherItems.length === 0">
      <p class="mt-4 text-sm text-[#166534]/75">No vouchers yet. Select one above to get started.</p>
    </template>
    <div class="mt-4 space-y-3" x-show="voucherItems.length > 0">
      <template x-for="item in voucherItems" :key="item.slug">
        <article class="rounded-2xl border border-[#e7f3ea] bg-[#f8fdf9] p-4">
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-sm font-semibold text-[#14532d]" x-text="item.name"></p>
              <p class="text-xs text-[#166534]/80" x-text="item.subtitle"></p>
            </div>
            <p class="text-sm font-semibold text-[#14532d]" x-text="item.displayValue"></p>
          </div>
          <div class="mt-3 flex items-center justify-between text-xs">
            <span class="inline-flex items-center gap-2 rounded-full px-3 py-1" :class="item.active ? 'bg-[#d9f2dd] text-[#14532d]' : 'bg-slate-200 text-slate-700'">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-3 w-3" fill="currentColor" aria-hidden="true">
                <path d="M9 16.17 4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
              </svg>
              <span x-text="item.active ? 'Active' : 'Used'"></span>
            </span>
            <span class="text-[#166534]/70" x-text="item.expiry"></span>
          </div>
        </article>
      </template>
    </div>
  </section>

  <!-- Claim + Mint Modal -->
  <div x-show="modalOpen" style="display:none" class="fixed inset-0 z-50 grid place-items-center bg-black/40">
    <div class="w-full max-w-sm rounded-2xl bg-white p-5 shadow-xl">
      <div class="flex items-start justify-between">
        <div>
          <p class="text-xs uppercase tracking-wide text-[#166534]/70">Claim & Mint</p>
          <h3 class="mt-1 text-base font-semibold text-[#14532d]" x-text="modalVoucherName"></h3>
        </div>
        <button class="text-slate-500" @click="closeModal()">✕</button>
      </div>
      <div class="mt-4 space-y-2 text-sm">
        <template x-if="step==='init'">
          <p>Preparing…</p>
        </template>
        <template x-if="step==='issuing'">
          <p>Issuing voucher to your wallet…</p>
        </template>
        <template x-if="step==='minting'">
          <p>Minting on-chain (ERC-1155)…</p>
        </template>
        <template x-if="step==='success'">
          <div class="space-y-2">
            <p class="text-[#15803d] font-semibold">Success! Your voucher was minted.</p>
            <template x-if="txExplorer">
              <a :href="txExplorer" target="_blank" class="text-xs text-[#166534] underline">View transaction</a>
            </template>
          </div>
        </template>
        <template x-if="step==='error'">
          <p class="text-[#b91c1c]">Mint failed: <span x-text="errorMessage"></span></p>
        </template>
      </div>
      <div class="mt-5 flex justify-end gap-2">
        <button x-show="step==='success'" class="rounded-full bg-[#15803d] px-4 py-2 text-xs font-semibold text-white" @click="finishAndRefresh()">Done</button>
        <button x-show="step==='error'" class="rounded-full bg-slate-200 px-4 py-2 text-xs font-semibold" @click="closeModal()">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
function homeView(){
  const formatCurrency = (value) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(value);
  return {
    demoMode: {{ demo_mode|yesno:"true,false" }},
    walletAddress: null,
    voucherCount: '-',
    voucherValue: '-',
    walletStatus: 'Checking wallet…',
    loggedIn: false,
    voucherItems: [],
    availableVouchers: JSON.parse(document.getElementById('available-vouchers').textContent),
    valueHidden: false,

    // limits from /me
    limits: [],

    // Manual code input
    manualCode: '',

    // QR Scanner state
    qrScannerActive: false,
    qrScanner: null,
    stream: null,
    statusMessage: 'Click "Scan QR Code" to start',

    // Modal state
    modalOpen: false,
    modalVoucherSlug: '',
    modalVoucherName: '',
    step: 'init', // init|issuing|minting|success|error
    errorMessage: '',
    txExplorer: null,

    init(){
      fetch('/me?format=json', { headers: { 'Accept': 'application/json' } })
        .then(r => r.ok ? r.json() : null)
        .then(data => {
          if(!data){
            this.walletStatus = 'Please sign in to continue.';
            this.loggedIn = false;
            return;
          }
          this.loggedIn = true;
          this.walletAddress = data.wallet_address || null;
          this.voucherCount = (data.voucher_total ?? '0') + '';
          this.walletStatus = this.walletAddress ? 'Custodial wallet ready.' : 'Wallet will be created on your first claim.';

          // limits
          this.limits = Array.isArray(data.limits) ? data.limits : [];

          const vouchers = Array.isArray(data.vouchers) ? data.vouchers : [];
          const mapped = vouchers.map((item) => {
            const balance = Number(item.balance || 0);
            const rawValue = Number(item.value_vnd ?? item.value ?? 0) || 0;
            const subtitle = item.description || 'StayToken reward';
            const expiry = item.expires_at ? `Expires: ${item.expires_at}` : '';
            const displayValue = rawValue > 0 ? formatCurrency(rawValue) : `${balance} voucher${balance === 1 ? '' : 's'}`;
            return {
              slug: item.slug,
              name: item.name || item.slug,
              subtitle,
              balance,
              rawValue,
              displayValue,
              active: balance > 0,
              expiry,
            };
          });
          this.voucherItems = mapped.slice(0, 4);

          const totalValue = mapped.reduce((acc, it) => acc + it.rawValue, 0);
          if(totalValue > 0){
            this.voucherValue = formatCurrency(totalValue);
          } else if (Number(this.voucherCount) > 0) {
            const count = Number(this.voucherCount);
            this.voucherValue = `${count} voucher${count === 1 ? '' : 's'}`;
          } else {
            this.voucherValue = '—';
          }

          // Check for pending voucher code after login
          this.checkPendingVoucherCode();
        })
        .catch(() => {
          this.walletStatus = 'Unable to load wallet info. Please sign in again.';
          this.loggedIn = false;
        });
        
      // Generate test QR code
      this.generateTestQR();
      
      // Fallback if qrcode library fails
      setTimeout(() => {
        if (typeof qrcode === 'undefined') {
          console.log('Using fallback QR code generation');
          this.generateTestQRCanvas();
        }
      }, 5000);
    },
    
    generateTestQR(){
      // Create a test QR code
      if (typeof qrcode !== 'undefined') {
        const testData = 'voucher:spa-30off-2025:claim';
        const qrContainer = document.getElementById('test-qr-code');
        if (qrContainer) {
          qrContainer.innerHTML = '';
          const qr = qrcode.make(testData);
          qrContainer.appendChild(qr);
        }
      } else {
        console.log('qrcode library not loaded yet, will retry...');
        // Try again after a longer delay
        setTimeout(() => this.generateTestQR(), 2000);
      }
    },
    
    // Alternative QR code generation using canvas
    generateTestQRCanvas(){
      const testData = 'voucher:spa-30off-2025:claim';
      const qrContainer = document.getElementById('test-qr-code');
      if (qrContainer) {
        qrContainer.innerHTML = '';
        const canvas = document.createElement('canvas');
        canvas.width = 128;
        canvas.height = 128;
        const ctx = canvas.getContext('2d');
        
        // Simple QR code simulation
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, 128, 128);
        ctx.fillStyle = '#fff';
        ctx.fillRect(8, 8, 112, 112);
        ctx.fillStyle = '#000';
        ctx.fillRect(16, 16, 96, 96);
        
        qrContainer.appendChild(canvas);
      }
    },
    
    testQRScanner(){
      // Simulate QR code detection for testing
      console.log('Testing QR Scanner...');
      const testData = 'voucher:spa-30off-2025:claim';
      console.log('Test QR data:', testData);
      this.processQRCode(testData);
    },

    checkPendingVoucherCode(){
      // Check if there's a pending voucher code from QR scan
      const pendingCode = sessionStorage.getItem('pending_voucher_code');
      if (pendingCode) {
        // Clear the pending code
        sessionStorage.removeItem('pending_voucher_code');
        
        // Process the voucher code
        this.claimVoucher(pendingCode);
      }
    },

    getLimit(slug){
      const it = this.limits.find(x => x.slug === slug);
      return it || { slug, limit: 0, claimed: 0, can_claim: true };
    },

    canClaim(slug){
      const it = this.getLimit(slug);
      if (!it) return true;
      if (!it.limit || it.limit <= 0) return true;
      return (it.claimed || 0) < (it.limit || 0);
    },

    limitBadge(slug){
      const it = this.getLimit(slug);
      if (!it || !it.limit || it.limit <= 0) return 'Unlimited';
      return `${it.claimed}/${it.limit}`;
    },

    limitSubtitle(slug){
      const it = this.getLimit(slug);
      if (!it || !it.limit || it.limit <= 0) return '';
      const remaining = Math.max(0, (it.limit || 0) - (it.claimed || 0));
      return remaining > 0 ? `You can claim ${remaining} more time(s)` : 'You have reached the claim limit';
    },

    shortAddress(addr){
      if(!addr) return '';
      return `${addr.slice(0, 10)}...${addr.slice(-6)}`;
    },

    toggleValue(){
      this.valueHidden = !this.valueHidden;
    },

    async copy(text){
      try { await navigator.clipboard.writeText(text); } catch (_) {}
    },

    openClaimModal(slug, name){
      if (!this.loggedIn) {
        const nextUrl = encodeURIComponent(window.location.pathname + window.location.search);
        window.location.href = `/auth/start?next=${nextUrl}`;
        return;
      }
      if (!this.canClaim(slug)) return;
      this.modalVoucherSlug = slug;
      this.modalVoucherName = name;
      this.errorMessage = '';
      this.txExplorer = null;
      this.step = 'issuing';
      this.modalOpen = true;
      this._startClaimMint();
    },

    closeModal(){
      this.modalOpen = false;
    },

    finishAndRefresh(){
      this.modalOpen = false;
      window.location.href = '/me';
    },

    async _startClaimMint(){
      try{
        if(this.demoMode){
          await new Promise(r => setTimeout(r, 800));
          this.step = 'minting';
          await new Promise(r => setTimeout(r, 1000));
          this.step = 'success';
          return;
        }
        this.step = 'minting';
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        const resp = await fetch(`/api/claim-mint/${this.modalVoucherSlug}`, { 
          method: 'POST', 
          headers: { 
            'Accept': 'application/json', 
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken
          } 
        });
        if (resp.status === 401) {
          const nextUrl = encodeURIComponent(window.location.pathname + window.location.search);
          window.location.href = `/auth/start?next=${nextUrl}`;
          return;
        }
        const data = await resp.json().catch(() => null);
        if(!resp.ok || !data || !data.ok){
          this.step = 'error';
          this.errorMessage = (data && (data.detail || data.error)) || 'Unknown error';
          return;
        }
        this.txExplorer = data.explorer || null;
        this.step = 'success';
        // Refresh local limit counter
        const it = this.limits.find(x => x.slug === this.modalVoucherSlug);
        if (it) { it.claimed = (it.claimed || 0) + 1; }
      }catch(err){
        this.step = 'error';
        this.errorMessage = (err && err.message) || 'Network error';
      }
    },

    // QR Scanner functions
    startQRScanner(){
      console.log('Starting QR Scanner...');
      // Check if device supports camera
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        this.statusMessage = 'Camera not supported on this device. Please use manual code input instead.';
        return;
      }
      
      // Check if we're on HTTPS or localhost
      const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
      if (!isSecure) {
        this.statusMessage = 'Camera requires HTTPS or localhost. Please use manual code input instead.';
        return;
      }
      
        // Check camera permissions
        if (navigator.permissions) {
          navigator.permissions.query({name: 'camera'}).then(result => {
            if (result.state === 'denied') {
              this.statusMessage = 'Camera permission denied. Please enable camera access in browser settings.';
              return;
            }
          }).catch(err => {
            console.log('Permission query failed:', err);
          });
        }
        
        // Check if camera is available
        navigator.mediaDevices.enumerateDevices().then(devices => {
          const videoDevices = devices.filter(device => device.kind === 'videoinput');
          if (videoDevices.length === 0) {
            this.statusMessage = 'No camera found. Please connect a camera and try again.';
            return;
          }
          console.log('Found video devices:', videoDevices.length);
        }).catch(err => {
          console.log('Device enumeration failed:', err);
        });
        
        // Add a small delay to allow permission checks
        setTimeout(() => {
          this.startCameraAndScan();
        }, 100);
    },

    async startCameraAndScan(){
      try {
        console.log('Starting camera...');
        this.qrScannerActive = true;
        this.statusMessage = 'Starting camera...';
        
        // Try different camera configurations
        const constraints = [
          { 
            video: { 
              facingMode: 'environment',
              width: { ideal: 1280 },
              height: { ideal: 720 }
            } 
          },
          { 
            video: { 
              facingMode: 'user',
              width: { ideal: 1280 },
              height: { ideal: 720 }
            } 
          },
          { 
            video: { 
              width: { ideal: 640 },
              height: { ideal: 480 }
            } 
          },
          { 
            video: { 
              width: { ideal: 320 },
              height: { ideal: 240 }
            } 
          },
          { video: true }
        ];
        
        let stream = null;
        for (const constraint of constraints) {
          try {
            console.log('Trying camera constraint:', constraint);
            stream = await navigator.mediaDevices.getUserMedia(constraint);
            console.log('Camera stream obtained with constraint:', constraint);
            break;
          } catch (err) {
            console.log('Failed with constraint:', constraint, err);
            continue;
          }
        }
        
        if (!stream) {
          throw new Error('No camera configuration worked');
        }
        
        this.stream = stream;
        
        // Ensure video element exists
        const video = this.$refs.video;
        if (!video) {
          console.error('Video element not found');
          throw new Error('Video element not found');
        }
        
        video.srcObject = this.stream;
        
        // Wait for video to be ready
        video.onloadedmetadata = () => {
          console.log('Video metadata loaded, starting scan loop...');
          this.statusMessage = 'Camera active. Point at QR code to scan.';
          // Start scanning loop after video is ready
          setTimeout(() => {
            if (this.qrScannerActive) {
              this.startScanningLoop();
            }
          }, 500);
        };
        
      } catch (error) {
        this.qrScannerActive = false;
        this.statusMessage = 'Camera access denied. Use manual input below.';
        console.error('Camera error:', error);
        
        // Don't show alert, just update status
        console.log('Camera access failed, falling back to manual input');
        
        // Show helpful message
        if (error.name === 'NotAllowedError') {
          this.statusMessage = 'Camera permission denied. Please allow camera access and try again.';
        } else if (error.name === 'NotFoundError') {
          this.statusMessage = 'No camera found. Please connect a camera and try again.';
        } else if (error.name === 'NotReadableError') {
          this.statusMessage = 'Camera is being used by another application. Please close other apps and try again.';
        } else {
          this.statusMessage = 'Camera access failed. Please use manual code input instead.';
        }
      }
    },

    startScanningLoop(){
      if (!this.qrScannerActive) return;
      
      // Check if jsQR is available
      if (typeof jsQR === 'undefined') {
        console.error('jsQR library not loaded');
        this.statusMessage = 'QR scanner library not loaded. Please refresh the page.';
        return;
      }
      
      // Use jsQR to detect QR codes
      const video = this.$refs.video;
      if (!video) {
        console.error('Video element not found in startScanningLoop');
        this.statusMessage = 'Video element not found. Please refresh the page.';
        return;
      }
      
      if (video.readyState < 2) {
        // Video not ready yet, try again
        setTimeout(() => {
          if (this.qrScannerActive) {
            this.startScanningLoop();
          }
        }, 100);
        return;
      }
      
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);
      
      if (code) {
        console.log('QR Code detected:', code.data);
        this.processQRCode(code.data);
        return;
      }
      
      // Continue scanning
      setTimeout(() => {
        if (this.qrScannerActive) {
          this.startScanningLoop();
        }
      }, 100);
    },

    processQRCode(qrData){
      // Process the detected QR code
      console.log('QR Code detected:', qrData);
      
      // Stop camera
      this.stopCamera();
      
      // Process the QR code
      this.handleQRCode(qrData);
    },

    async handleQRCode(qrData){
      // Parse QR code data
      console.log('Processing QR code data:', qrData);
      
      // Validate QR data
      if (!qrData || qrData.trim() === '') {
        console.error('Empty QR code data');
        this.statusMessage = 'Invalid QR code. Please try again.';
        return;
      }
      
      // Expected format: "voucher:spa-30off-2025:claim" or just "spa-30off-2025_abc123"
      let voucherCode = qrData.trim();
      
      // If it's a voucher QR format, extract the code
      if (qrData.startsWith('voucher:')) {
        const parts = qrData.split(':');
        if (parts.length >= 2) {
          voucherCode = parts[1]; // Extract voucher slug
        }
      }
      
      // Validate voucher code
      if (!voucherCode || voucherCode.trim() === '') {
        console.error('Empty voucher code after parsing');
        this.statusMessage = 'Invalid voucher code. Please try again.';
        return;
      }
      
      console.log('Processed voucher code:', voucherCode);
      
      // Check if user is logged in
      if (!this.loggedIn) {
        // Store the voucher code in session and redirect to auth
        sessionStorage.setItem('pending_voucher_code', voucherCode);
        const nextUrl = encodeURIComponent(window.location.pathname + window.location.search);
        window.location.href = `/auth/start?next=${nextUrl}`;
        return;
      }
      
      // User is logged in, proceed with claim
      await this.claimVoucher(voucherCode);
    },

    async claimVoucher(code){
      try {
        console.log('Claiming voucher with code:', code);
        
        // Validate code before proceeding
        if (!code || code.trim() === '') {
          console.error('Empty voucher code in claimVoucher');
          this.statusMessage = 'Invalid voucher code. Please try again.';
          return;
        }
        
        this.statusMessage = 'Processing voucher...';
        
        // Show loading modal
        this.modalVoucherName = 'Processing...';
        this.step = 'issuing';
        this.modalOpen = true;
        
        // Redirect to claim page - this will handle the full flow
        const claimUrl = `/claim/${encodeURIComponent(code)}/`;
        console.log('Redirecting to:', claimUrl);
        window.location.href = claimUrl;
        
      } catch (error) {
        this.step = 'error';
        this.errorMessage = error.message || 'Network error';
        console.error('Claim error:', error);
      }
    },

    stopCamera(){
      if (this.stream) {
        this.stream.getTracks().forEach(track => track.stop());
        this.stream = null;
      }
      this.qrScannerActive = false;
      this.statusMessage = 'Camera stopped.';
    },

    // Manual code claim
    async claimByCode(){
      const code = this.manualCode.trim();
      if (!code) {
        this.statusMessage = 'Please enter a voucher code.';
        return;
      }
      
      console.log('Manual claim with code:', code);
      
      // Check if user is logged in
      if (!this.loggedIn) {
        // Store the voucher code in session and redirect to auth
        sessionStorage.setItem('pending_voucher_code', code);
        const nextUrl = encodeURIComponent(window.location.pathname + window.location.search);
        window.location.href = `/auth/start?next=${nextUrl}`;
        return;
      }
      
      // User is logged in, proceed with claim
      await this.claimVoucher(code);
    },
  };
}
</script>
{% endblock %}