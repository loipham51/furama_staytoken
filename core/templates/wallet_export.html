{% extends "base.html" %}
{% block title %}Transfer Vouchers - Furama StayToken{% endblock %}
{% block content %}
<div x-data="walletExport()" class="space-y-4 rounded-2xl bg-white p-5 shadow">
  <div class="flex items-start gap-3">
    <div class="grid h-10 w-10 place-items-center rounded-xl bg-blue-600 text-lg font-semibold text-white">
      <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
      </svg>
    </div>
    <div>
      <h1 class="text-lg font-semibold">Transfer Vouchers</h1>
      <p class="text-sm text-gray-600">Send your vouchers to a personal wallet address.</p>
    </div>
  </div>

  <div class="rounded-xl bg-blue-50 p-4 text-sm text-blue-800">
    <div class="flex items-start gap-2">
      <svg class="h-5 w-5 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <div>
        <div class="font-medium mb-1">How it works</div>
        <div>Enter your personal wallet address and select vouchers to transfer. The transfer will be processed securely on-chain.</div>
      </div>
    </div>
  </div>

  <div class="space-y-4">
    <label class="block">
      <span class="text-sm font-medium text-gray-700">Destination wallet address</span>
      <div class="mt-1 text-xs text-gray-500 mb-2">Enter your personal wallet address (starts with 0x...)</div>
      <input x-model="to" class="w-full rounded-xl border border-gray-300 p-3 font-mono text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="0x742d35Cc6634C0532925a3b8D4C9db96C4b4d8b6">
    </label>
    
    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
      <label class="block">
        <span class="text-sm font-medium text-gray-700">Voucher type</span>
        <div class="mt-1 text-xs text-gray-500 mb-2">Enter the voucher slug</div>
        <input x-model="slug" class="w-full rounded-xl border border-gray-300 p-3 text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="spa-30off-2025">
      </label>
      <label class="block">
        <span class="text-sm font-medium text-gray-700">Quantity</span>
        <div class="mt-1 text-xs text-gray-500 mb-2">Number of vouchers to transfer</div>
        <input x-model.number="amount" type="number" min="1" class="w-full rounded-xl border border-gray-300 p-3 text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500" value="1">
      </label>
    </div>
    
    <button @click="sendTransfer" :disabled="sending" class="flex w-full items-center justify-center gap-2 rounded-xl bg-blue-600 py-3 text-sm font-semibold text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
      <svg x-show="!sending" class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
      </svg>
      <span x-show="!sending">Transfer Vouchers</span>
      <svg x-show="sending" class="h-4 w-4 animate-spin" viewBox="0 0 24 24" fill="none">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" />
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" />
      </svg>
      <span x-show="sending">Processing...</span>
    </button>
    
    <div class="rounded-xl bg-gray-50 p-3 text-xs text-gray-600">
      <div class="flex items-start gap-2">
        <svg class="h-4 w-4 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
        </svg>
        <div>
          <div class="font-medium mb-1">Security Notice</div>
          <div>Transfers are processed securely on-chain. Please ensure the destination address is correct as transfers cannot be reversed.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function walletExport(){
  return {
    to: '',
    slug: 'spa-30off-2025',
    amount: 1,
    sending: false,
    async sendTransfer(){
      const to = (this.to || '').trim();
      const slug = (this.slug || '').trim();
      const amount = Number(this.amount || 1);
      
      // Validation
      if(!to || !to.startsWith('0x') || to.length < 10){ 
        alert('Please enter a valid destination wallet address (starts with 0x...).'); 
        return; 
      }
      if(!slug){ 
        alert('Please enter the voucher slug.'); 
        return; 
      }
      if(amount <= 0){ 
        alert('Quantity must be at least 1.'); 
        return; 
      }
      
      this.sending = true;
      try {
        const res = await fetch('/wallet/transfer', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ to_address: to, voucher: slug, amount })
        });
        const json = await res.json();
        if(json.ok){
          alert('Transfer queued successfully! Please allow a short processing time.');
          // Reset form
          this.to = '';
          this.slug = 'spa-30off-2025';
          this.amount = 1;
        } else {
          alert('Error: ' + (json.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Network error. Please try again.');
      } finally {
        this.sending = false;
      }
    }
  };
}
</script>
{% endblock %}

