{% extends "base.html" %}
{% block title %}My Vouchers - Furama StayToken{% endblock %}
{% block content %}
<div class="space-y-4 rounded-2xl bg-white p-5 shadow">
  <h1 class="text-lg font-semibold">My Vouchers</h1>

  {% if balances %}
    <div class="space-y-2">
      <ul class="space-y-2">
        {% for b in balances %}
        <li class="flex items-center justify-between rounded-xl border p-3 cursor-pointer hover:bg-gray-50" onclick="openVoucherModal('{{ b.slug }}', '{{ b.name }}', '{{ wallet.address_hex }}', '{{ b.qr_claim_code|default:"" }}')">
          <div>
            <div class="text-sm font-medium">{{ b.name }}</div>
            <div class="text-xs text-gray-500">{{ b.slug }}</div>
          </div>
          <div class="text-lg font-semibold">{{ b.balance }}</div>
        </li>
        {% endfor %}
      </ul>
    </div>

    <!-- Bottom Navigation -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4">
      <div class="grid grid-cols-3 gap-2 max-w-md mx-auto">
        <a href="/me" class="flex flex-col items-center py-2 text-xs text-gray-600 hover:text-blue-600">
          <svg class="h-5 w-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
          </svg>
          Profile
        </a>
        <a href="/my-wallet" class="flex flex-col items-center py-2 text-xs text-gray-600 hover:text-blue-600">
          <svg class="h-5 w-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
          </svg>
          Wallet
        </a>
        <a href="/my-vouchers" class="flex flex-col items-center py-2 text-xs text-blue-600">
          <svg class="h-5 w-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
          </svg>
          Vouchers
        </a>
      </div>
    </div>
    
    <div class="grid grid-cols-2 gap-3 pt-2 pb-20">
      <a href="/my-wallet" class="rounded-xl border py-3 text-sm text-center">Back to Wallet</a>
      <a href="/" class="rounded-xl bg-slate-900 py-3 text-sm font-semibold text-white text-center">Claim More</a>
    </div>
  {% else %}
    <div class="text-center py-8">
      <div class="text-sm text-gray-500 mb-4">You do not have any vouchers yet.</div>
      <a href="/" class="inline-block rounded-xl bg-slate-900 px-6 py-3 text-sm font-semibold text-white">Claim Your First Voucher</a>
    </div>
  {% endif %}
</div>

<!-- Voucher Modal -->
<div id="voucherModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50">
  <div class="flex min-h-full items-center justify-center p-4">
    <div class="w-full max-w-sm rounded-2xl bg-white p-6 shadow-xl">
      <div class="flex items-center justify-between mb-4">
        <h3 id="modalVoucherName" class="text-lg font-semibold text-gray-900"></h3>
        <button onclick="closeVoucherModal()" class="text-gray-400 hover:text-gray-600">
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      
      <div class="space-y-4">
        <div class="text-center">
          <div class="text-sm text-gray-500 mb-2">Voucher QR Code</div>
          <img id="modalQRCode" src="" alt="Voucher QR" class="mx-auto h-48 w-48 rounded-xl border">
        </div>
        
        <div class="space-y-2">
          <button onclick="downloadVoucherQR()" class="w-full flex items-center justify-center gap-2 rounded-xl bg-blue-600 px-4 py-3 text-sm font-semibold text-white hover:bg-blue-700">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-4 w-4" fill="currentColor">
              <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
            </svg>
            Download QR Code
          </button>
          
          <div class="text-center">
            <div class="text-xs text-gray-500 mb-2">For POS Staff</div>
            <div class="text-xs text-gray-400">Show this QR code to staff for redemption</div>
            <div id="qrCodeInfo" class="text-xs text-gray-400 mt-2 hidden">
              QR Code: <span id="qrCodeValue" class="font-mono"></span>
            </div>
          </div>
          
          <button onclick="closeVoucherModal()" class="w-full rounded-xl border px-4 py-3 text-sm font-semibold text-gray-700 hover:bg-gray-50">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let currentVoucherSlug = '';
let currentWalletAddress = '';

function openVoucherModal(slug, name, walletAddress, qrClaimCode) {
  currentVoucherSlug = slug;
  currentWalletAddress = walletAddress;
  
  document.getElementById('modalVoucherName').textContent = name;
  
  // Generate QR code URL - use QRClaim code if available, otherwise fallback to voucher QR
  let qrUrl;
  if (qrClaimCode) {
    qrUrl = `/qr/claim/${qrClaimCode}.png`;
    // Show QRClaim code info
    document.getElementById('qrCodeValue').textContent = qrClaimCode;
    document.getElementById('qrCodeInfo').classList.remove('hidden');
  } else {
    qrUrl = `/qr/voucher/${slug}/${walletAddress.replace('0x', '')}.png`;
    // Hide QRClaim code info
    document.getElementById('qrCodeInfo').classList.add('hidden');
  }
  document.getElementById('modalQRCode').src = qrUrl;
  
  // Show modal
  document.getElementById('voucherModal').classList.remove('hidden');
}

function closeVoucherModal() {
  document.getElementById('voucherModal').classList.add('hidden');
}

function downloadVoucherQR() {
  const qrImage = document.getElementById('modalQRCode');
  if (!qrImage || !qrImage.src) {
    alert('QR code not available');
    return;
  }
  
  // Create a temporary link element
  const link = document.createElement('a');
  link.href = qrImage.src;
  link.download = `${currentVoucherSlug}-qr-code.png`;
  
  // Trigger download
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Close modal when clicking outside
document.getElementById('voucherModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeVoucherModal();
  }
});
</script>
{% endblock %}
