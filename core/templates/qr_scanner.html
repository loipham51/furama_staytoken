{% extends "base.html" %}
{% block title %}QR Scanner - StayToken{% endblock %}
{% block content %}
<div x-data="qrScannerView()" x-init="init()" class="mx-auto flex max-w-md flex-col gap-5 px-4 pb-16 pt-6">
  <!-- Header -->
  <section class="rounded-3xl border border-[#dfeee2] bg-white p-6 shadow-sm">
    <div class="flex items-center gap-3">
      <button @click="goBack()" class="text-[#166534]">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-6 w-6" fill="currentColor">
          <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
        </svg>
      </button>
      <div>
        <h1 class="text-lg font-semibold text-[#14532d]">Scan QR Code</h1>
        <p class="text-sm text-[#166534]/80">Point your camera at a voucher QR code</p>
      </div>
    </div>
  </section>

  <!-- Scanner Area -->
  <section class="rounded-3xl border border-[#dfeee2] bg-white p-6 shadow-sm">
    <div class="text-center">
      <div class="relative mx-auto mb-4 h-64 w-64 overflow-hidden rounded-2xl border-2 border-[#15803d] bg-black">
        <video 
          x-ref="video" 
          class="h-full w-full object-cover"
          autoplay
          playsinline
        ></video>
        <canvas 
          x-ref="canvas" 
          class="hidden"
        ></canvas>
        
        <!-- Scanner overlay -->
        <div class="absolute inset-0 flex items-center justify-center">
          <div class="h-48 w-48 rounded-lg border-2 border-white shadow-lg"></div>
        </div>
        
        <!-- Loading indicator -->
        <div x-show="loading" class="absolute inset-0 flex items-center justify-center bg-black/50">
          <div class="text-white">
            <div class="h-8 w-8 animate-spin rounded-full border-2 border-white border-t-transparent"></div>
            <p class="mt-2 text-sm">Starting camera...</p>
          </div>
        </div>
      </div>
      
      <p class="text-sm text-[#166534]/80" x-text="statusMessage"></p>
      
      <div class="mt-4 space-y-2">
        <button 
          @click="toggleCamera()"
          class="w-full rounded-xl bg-[#15803d] px-4 py-2 text-sm font-semibold text-white"
          x-text="cameraActive ? 'Stop Camera' : 'Start Camera'"
        ></button>
        
        <button 
          @click="goBack()"
          class="w-full rounded-xl border border-[#e7f3ea] px-4 py-2 text-sm font-semibold text-[#166534]"
        >
          Cancel
        </button>
      </div>
    </div>
  </section>

  <!-- Manual Input Fallback -->
  <section class="rounded-3xl border border-[#dfeee2] bg-white p-6 shadow-sm">
    <div class="text-center">
      <p class="text-sm text-[#166534]/80 mb-3">Camera not working?</p>
      <div class="flex gap-2">
        <input 
          type="text" 
          x-model="manualCode"
          @keyup.enter="claimByCode()"
          placeholder="Enter voucher code manually..."
          class="flex-1 rounded-xl border border-[#e7f3ea] px-3 py-2 text-sm placeholder:text-[#166534]/50 focus:border-[#15803d] focus:outline-none"
        />
        <button 
          @click="claimByCode()"
          :disabled="!manualCode.trim()"
          class="rounded-xl bg-[#15803d] px-4 py-2 text-sm font-semibold text-white disabled:bg-slate-300 disabled:cursor-not-allowed"
        >
          Claim
        </button>
      </div>
    </div>
  </section>
</div>

<script>
function qrScannerView() {
  return {
    video: null,
    canvas: null,
    stream: null,
    cameraActive: false,
    loading: false,
    statusMessage: 'Click "Start Camera" to begin scanning',
    manualCode: '',
    scanning: false,

    init() {
      this.video = this.$refs.video;
      this.canvas = this.$refs.canvas;
    },

    async toggleCamera() {
      if (this.cameraActive) {
        this.stopCamera();
      } else {
        await this.startCamera();
      }
    },

    async startCamera() {
      this.loading = true;
      this.statusMessage = 'Requesting camera access...';
      
      try {
        this.stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'environment', // Use back camera if available
            width: { ideal: 1280 },
            height: { ideal: 720 }
          } 
        });
        
        this.video.srcObject = this.stream;
        this.cameraActive = true;
        this.statusMessage = 'Camera active. Point at QR code to scan.';
        this.loading = false;
        
        // Start scanning loop
        this.startScanning();
        
      } catch (error) {
        this.loading = false;
        this.statusMessage = 'Camera access denied or not available. Use manual input below.';
        console.error('Camera error:', error);
      }
    },

    stopCamera() {
      if (this.stream) {
        this.stream.getTracks().forEach(track => track.stop());
        this.stream = null;
      }
      this.video.srcObject = null;
      this.cameraActive = false;
      this.scanning = false;
      this.statusMessage = 'Camera stopped.';
    },

    startScanning() {
      if (!this.cameraActive || this.scanning) return;
      
      this.scanning = true;
      this.scanLoop();
    },

    async scanLoop() {
      if (!this.scanning || !this.cameraActive) return;
      
      try {
        // Simple QR detection - in a real app you'd use a library like jsQR
        // For now, we'll simulate detection
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Check if video is ready
        if (this.video.readyState >= 2) {
          // In a real implementation, you would:
          // 1. Draw video frame to canvas
          // 2. Use jsQR library to detect QR codes
          // 3. Process the detected code
          
          // For demo purposes, we'll just continue scanning
        }
        
        if (this.scanning) {
          requestAnimationFrame(() => this.scanLoop());
        }
      } catch (error) {
        console.error('Scan error:', error);
        this.scanning = false;
      }
    },

    processQRCode(code) {
      // Process the detected QR code
      this.statusMessage = `Detected: ${code}`;
      
      // Stop camera
      this.stopCamera();
      
      // Redirect to claim page
      window.location.href = `/claim/${code}`;
    },

    claimByCode() {
      const code = this.manualCode.trim();
      if (!code) return;
      
      window.location.href = `/claim/${code}`;
    },

    goBack() {
      this.stopCamera();
      window.history.back();
    }
  };
}
</script>
{% endblock %}

