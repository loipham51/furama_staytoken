{% extends "base_admin.html" %}
{% block title %}Voucher Management - StayToken{% endblock %}
{% block content %}
{% csrf_token %}
<div class="space-y-4 pb-16">
  <section class="rounded-2xl border bg-white p-4 shadow-sm">
    <div class="flex items-start gap-2.5">
      <div class="grid h-10 w-10 place-items-center rounded-xl bg-slate-900 text-xs font-semibold text-white">VCH</div>
      <div class="min-w-0">
        <h1 class="text-base font-semibold text-slate-900">Vouchers</h1>
        <p class="text-sm text-slate-500">Search voucher campaigns by slug or name. 20 records per page.</p>
      </div>
    </div>
    <form method="get" class="mt-3 flex flex-wrap items-center gap-2">
      <input type="text" name="q" value="{{ q }}" class="w-full flex-1 rounded-xl border p-2.5 text-sm" placeholder="Keyword (e.g. spa-30off, summer, ...)" />
      <button class="shrink-0 rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white">Search</button>
      <a href="?q=" class="shrink-0 rounded-xl border px-3 py-2 text-sm text-slate-600 hover:bg-slate-50">Clear</a>
    </form>
    <div class="mt-3 flex gap-2">
      <a href="/adv1/admin/vouchers/new" class="inline-flex items-center rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white">New voucher</a>
      <button onclick="exportVoucherQRs()" class="inline-flex items-center rounded-xl bg-blue-600 px-4 py-2 text-sm font-semibold text-white">Export QR Codes</button>
    </div>
  </section>

  <section class="rounded-2xl border bg-white shadow-sm">
    <div class="overflow-x-auto">
      <div class="min-w-[600px]">
        <div class="grid grid-cols-6 gap-0 border-b bg-slate-50 px-4 py-2 text-[11px] font-medium uppercase tracking-wide text-slate-500">
          <div>Slug</div>
          <div>Name</div>
          <div>Status</div>
          <div>Token ID</div>
          <div>Created</div>
          <div></div>
        </div>
        <div class="divide-y">
          {% for it in page_obj.object_list %}
          <div class="grid grid-cols-6 gap-2 px-4 py-3 text-sm" data-voucher-slug="{{ it.slug }}">
            <div class="truncate font-mono" title="{{ it.slug }}">{{ it.slug }}</div>
            <div class="truncate" title="{{ it.name }}">{{ it.name }}</div>
            <div>
              {% if it.active %}
                <span class="rounded-full border border-emerald-100 bg-emerald-50 px-2 py-0.5 text-[11px] text-emerald-700">Running</span>
              {% else %}
                <span class="rounded-full border px-2 py-0.5 text-[11px] text-slate-600">Disabled</span>
              {% endif %}
            </div>
            <div class="font-mono">{{ it.token_id }}</div>
            <div>{{ it.created_at|date:'Y-m-d H:i'|default:"N/A" }}</div>
            <div class="flex items-center gap-2">
              <a href="/adv1/admin/vouchers/{{ it.slug }}/edit" class="rounded border px-2 py-1 text-xs">Edit</a>
              <form method="post" action="/adv1/admin/vouchers/{{ it.slug }}/delete" onsubmit="return confirm('Delete voucher {{ it.slug }}?');">
                {% csrf_token %}
                <button class="rounded border px-2 py-1 text-xs text-rose-700">Delete</button>
              </form>
            </div>
          </div>
          {% empty %}
          <div class="px-4 py-6 text-sm text-slate-500">No data.</div>
          {% endfor %}
        </div>
      </div>
    </div>
    <div class="flex items-center justify-between border-t bg-slate-50 px-4 py-2 text-sm">
      <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
      <div class="flex items-center gap-2">
        {% if page_obj.has_previous %}
          <a class="rounded border px-2 py-1" href="?page={{ page_obj.previous_page_number }}&q={{ q }}">Previous</a>
        {% else %}
          <span class="cursor-not-allowed rounded border px-2 py-1 text-slate-400">Previous</span>
        {% endif %}
        {% if page_obj.has_next %}
          <a class="rounded border px-2 py-1" href="?page={{ page_obj.next_page_number }}&q={{ q }}">Next</a>
        {% else %}
          <span class="cursor-not-allowed rounded border px-2 py-1 text-slate-400">Next</span>
        {% endif %}
      </div>
    </div>
  </section>
</div>

<script>
function exportVoucherQRs() {
  // Get selected vouchers or all vouchers
  const selectedVouchers = getSelectedVouchers();
  if (selectedVouchers.length === 0) {
    alert('Please select vouchers to export QR codes for.');
    return;
  }
  
  // Show loading
  const button = event.target;
  const originalText = button.textContent;
  button.textContent = 'Generating PDF...';
  button.disabled = true;
  
  // Create form and submit
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '/adv1/admin/vouchers/export-qr-pdf';
  
  // Add CSRF token
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
  if (csrfToken) {
    form.appendChild(csrfToken.cloneNode());
  }
  
  // Add selected vouchers
  selectedVouchers.forEach(slug => {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'vouchers';
    input.value = slug;
    form.appendChild(input);
  });
  
  document.body.appendChild(form);
  form.submit();
  
  // Reset button after a delay
  setTimeout(() => {
    button.textContent = originalText;
    button.disabled = false;
  }, 3000);
}

function getSelectedVouchers() {
  // For now, return all vouchers on the page
  // In a real implementation, you might have checkboxes for selection
  const vouchers = [];
  document.querySelectorAll('[data-voucher-slug]').forEach(el => {
    vouchers.push(el.dataset.voucherSlug);
  });
  return vouchers;
}
</script>
{% endblock %}








