{% extends "base_admin.html" %}
{% block title %}Voucher Management - StayToken{% endblock %}
{% block content %}
{% csrf_token %}
<div class="space-y-4 pb-16">
  <section class="rounded-2xl border bg-white p-4 shadow-sm">
    <div class="flex items-start gap-2.5">
      <div class="grid h-10 w-10 place-items-center rounded-xl bg-slate-900 text-xs font-semibold text-white">VCH</div>
      <div class="min-w-0">
        <h1 class="text-base font-semibold text-slate-900">Vouchers</h1>
        <p class="text-sm text-slate-500">Search voucher campaigns by slug or name. 20 records per page.</p>
      </div>
    </div>
    <form method="get" class="mt-3 flex flex-wrap items-center gap-2">
      <input type="text" name="q" value="{{ q }}" class="w-full flex-1 rounded-xl border p-2.5 text-sm" placeholder="Keyword (e.g. spa-30off, summer, ...)" />
      <button class="shrink-0 rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white">Search</button>
      <a href="?q=" class="shrink-0 rounded-xl border px-3 py-2 text-sm text-slate-600 hover:bg-slate-50">Clear</a>
    </form>
    <div class="mt-3 flex gap-2">
      <a href="/adv1/admin/vouchers/new" class="inline-flex items-center rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white">New voucher</a>
    </div>
  </section>

  <section class="rounded-2xl border bg-white shadow-sm">
    <div class="overflow-x-auto">
      <div class="min-w-[600px]">
        <div class="grid grid-cols-8 gap-0 border-b bg-slate-50 px-4 py-2 text-[11px] font-medium uppercase tracking-wide text-slate-500">
          <div>Slug</div>
          <div>Name</div>
          <div>Status</div>
          <div>Token ID</div>
          <div>Codes</div>
          <div>Used</div>
          <div>Created</div>
          <div></div>
        </div>
        <div class="divide-y">
          {% for it in page_obj.object_list %}
          <div class="grid grid-cols-8 gap-2 px-4 py-3 text-sm" data-voucher-slug="{{ it.slug }}">
            <div class="truncate font-mono" title="{{ it.slug }}">{{ it.slug }}</div>
            <div class="truncate" title="{{ it.name }}">{{ it.name }}</div>
            <div>
              {% if it.active %}
                <span class="rounded-full border border-emerald-100 bg-emerald-50 px-2 py-0.5 text-[11px] text-emerald-700">Running</span>
              {% else %}
                <span class="rounded-full border px-2 py-0.5 text-[11px] text-slate-600">Disabled</span>
              {% endif %}
            </div>
            <div class="font-mono">{{ it.token_id }}</div>
            <div class="text-center">
              <span class="rounded-full bg-blue-100 px-2 py-1 text-xs font-medium text-blue-800">{{ it.total_codes|default:0 }}</span>
            </div>
            <div class="text-center">
              <span class="rounded-full bg-green-100 px-2 py-1 text-xs font-medium text-green-800">{{ it.used_codes|default:0 }}</span>
            </div>
            <div>{{ it.created_at|date:'Y-m-d H:i'|default:"N/A" }}</div>
            <div class="flex items-center gap-2">
              <a href="/adv1/admin/vouchers/{{ it.slug }}/edit" class="rounded border px-2 py-1 text-xs">Edit</a>
              <button onclick="showQRModal('{{ it.slug }}', '{{ it.name }}')" class="rounded border px-2 py-1 text-xs text-blue-700">Export QR</button>
              <form method="post" action="/adv1/admin/vouchers/{{ it.slug }}/delete" onsubmit="return confirm('Delete voucher {{ it.slug }}?');">
                {% csrf_token %}
                <button class="rounded border px-2 py-1 text-xs text-rose-700">Delete</button>
              </form>
            </div>
          </div>
          {% empty %}
          <div class="px-4 py-6 text-sm text-slate-500">No data.</div>
          {% endfor %}
        </div>
      </div>
    </div>
    <div class="flex items-center justify-between border-t bg-slate-50 px-4 py-2 text-sm">
      <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
      <div class="flex items-center gap-2">
        {% if page_obj.has_previous %}
          <a class="rounded border px-2 py-1" href="?page={{ page_obj.previous_page_number }}&q={{ q }}">Previous</a>
        {% else %}
          <span class="cursor-not-allowed rounded border px-2 py-1 text-slate-400">Previous</span>
        {% endif %}
        {% if page_obj.has_next %}
          <a class="rounded border px-2 py-1" href="?page={{ page_obj.next_page_number }}&q={{ q }}">Next</a>
        {% else %}
          <span class="cursor-not-allowed rounded border px-2 py-1 text-slate-400">Next</span>
        {% endif %}
      </div>
    </div>
  </section>
</div>

<!-- QR Code Modal -->
<div id="qrModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50">
  <div class="flex min-h-full items-center justify-center p-4">
    <div class="w-full max-w-md rounded-2xl bg-white p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-slate-900" id="qrModalTitle">Voucher QR Code</h3>
        <button onclick="closeQRModal()" class="text-slate-400 hover:text-slate-600">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="text-center">
        <div class="mb-4">
          <img id="qrImage" src="" alt="Voucher QR Code" class="mx-auto h-48 w-48 rounded-xl border" style="display: none;">
          <div id="qrLoading" class="mx-auto h-48 w-48 rounded-xl border bg-white flex items-center justify-center text-slate-500">
            <div>
              <svg class="animate-spin h-8 w-8 mx-auto" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <p class="mt-2 text-sm">Loading QR...</p>
            </div>
          </div>
        </div>
        
        <div class="mb-4">
          <p class="text-sm text-slate-600" id="qrModalDescription">Scan this QR code to claim the voucher</p>
        </div>
        
        <div class="flex gap-2">
          <button onclick="downloadQR()" class="flex-1 rounded-xl bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700">
            Download QR
          </button>
          <button onclick="closeQRModal()" class="rounded-xl border px-4 py-2 text-sm text-slate-600">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
let currentQRImage = null;

function showQRModal(slug, name) {
  // Set modal title and description
  document.getElementById('qrModalTitle').textContent = `${name} QR Code`;
  document.getElementById('qrModalDescription').textContent = `Scan this QR code to claim the ${name} voucher`;
  
  // Show modal
  document.getElementById('qrModal').classList.remove('hidden');
  
  // Show loading
  document.getElementById('qrLoading').style.display = 'flex';
  document.getElementById('qrImage').style.display = 'none';
  
  // Generate QR code via API
  generateQRCode(slug, name);
}

function generateQRCode(slug, name) {
  // Show loading state
  const loading = document.getElementById('qrLoading');
  const qrImage = document.getElementById('qrImage');
  
  // Reset loading content
  loading.innerHTML = `
    <div>
      <svg class="animate-spin h-8 w-8 mx-auto" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <p class="mt-2 text-sm">Generating QR code...</p>
    </div>
  `;
  loading.style.display = 'flex';
  qrImage.style.display = 'none';
  
  // Call API to generate QR code
  fetch(`/adv1/admin/vouchers/${slug}/generate-qr`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    }
  })
  .then(response => response.json())
  .then(data => {
    console.log('DEBUG: API Response:', data);
    if (data.success) {
      // Load the generated QR image
      console.log('DEBUG: Loading QR image from:', data.qr_url);
      qrImage.src = data.qr_url;
      qrImage.onload = function() {
        console.log('DEBUG: QR image loaded successfully');
        // Hide loading and show QR image
        loading.style.display = 'none';
        qrImage.style.display = 'block';
        currentQRImage = data.qr_url;
      };
      qrImage.onerror = function() {
        console.log('DEBUG: QR image failed to load');
        // Show error if image fails to load
        loading.innerHTML = '<div class="text-red-500 text-sm">Error loading QR code</div>';
      };
    } else {
      console.log('DEBUG: API returned error:', data.message);
      // Show error message
      loading.innerHTML = '<div class="text-red-500 text-sm">' + (data.message || 'Error generating QR code') + '</div>';
    }
  })
  .catch(error => {
    console.error('Error generating QR code:', error);
    loading.innerHTML = '<div class="text-red-500 text-sm">Network error generating QR code</div>';
  });
}

function closeQRModal() {
  document.getElementById('qrModal').classList.add('hidden');
  currentQRImage = null;
}

function downloadQR() {
  if (!currentQRImage) {
    alert('QR code not available');
    return;
  }
  
  // Create download link
  const link = document.createElement('a');
  link.href = currentQRImage;
  link.download = `voucher-${document.getElementById('qrModalTitle').textContent.toLowerCase().replace(/\s+/g, '-')}-qr.png`;
  
  // Trigger download
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Close modal when clicking outside
document.getElementById('qrModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeQRModal();
  }
});
</script>

{% endblock %}








